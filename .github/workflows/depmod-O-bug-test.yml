name: depmod O bug test

# Only runs when you manually click "Run workflow" in GitHub Actions
on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-22.04   # change to ubuntu-24.04 if you want, both have the bug
    steps:
      - name: Show kmod version
        run: kmod --version || depmod --version

      - name: Trigger the malformed command (should show the infamous O)
        run: |
          echo "=== Expected: unrecognized option: O ==="
          depmod -FSystem.map || true

      - name: (Optional) Upgrade kmod and prove the O disappears
        run: |
          echo "=== Upgrading kmod to a fixed version ==="
          sudo apt update
          sudo apt install -y wget
          wget http://archive.ubuntu.com/ubuntu/pool/main/k/kmod/libkmod2_32-1ubuntu1_amd64.deb
          wget http://archive.ubuntu.com/ubuntu/pool/main/k/kmod/kmod_32-1ubuntu1_amd64.deb
          sudo dpkg -i libkmod2_32-1ubuntu1_amd64.deb kmod_32-1ubuntu1_amd64.deb || true

          kmod --version
          echo "=== Now the same command should say 'No such file' instead of O ==="
          depmod -FSystem.map || true
